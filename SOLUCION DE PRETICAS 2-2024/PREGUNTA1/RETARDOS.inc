;**************************** LIBRERÍA "RETARDOS.INC" *********************************
;
;	===================================================================
;	  DEL LIBRO "MICROCONTROLADOR PIC16F84. DESARROLLO DE PROYECTOS"
;	  E. PALACIOS, F. REMIRO Y L. LÓPEZ.
; 	  EDITORIAL RA-MA.  WWW.RA-MA.ES
;	===================================================================
;
; LIBRERÍA CON MÚLTIPLES SUBRUTINAS DE RETARDOS, DESDE 4 MICROSEGUNDOS HASTA 20 SEGUNDOS. 
; ADEMÁS SE PUEDEN IMPLEMENTAR OTRAS SUBRUTINAS MUY FÁCILMENTE.
;
; SE HAN CALCULADO PARA UN SISTEMA MICROCONTROLADOR CON UN PIC TRABAJANDO CON UN CRISTAL
; DE CUARZO A 4 MHZ. COMO CADA CICLO MÁQUINA SON 4 CICLOS DE RELOJ, RESULTA QUE CADA
; CICLO MÁQUINA TARDA 4 X 1/4MHZ = 1 µS.
;
; EN LOS COMENTARIOS, "CM" SIGNIFICA "CICLOS MÁQUINA".
;
; ZONA DE DATOS *********************************************************************

	CBLOCK     0X0C
	R_CONTA				; CONTADORES PARA LOS RETARDOS.
	R_CONTB
	R_CONTC
	ENDC
;
; RETARDOS DE 4 HASTA 10 MICROSEGUNDOS ---------------------------------------------------
;
; A CONTINUACIÓN RETARDOS PEQUEÑOS TENIENDO EN CUENTA QUE PARA UNA FRECUENCIA DE 4 MHZ,
; LA LLAMADA A SUBRUTINA "CALL" TARDA 2 CICLOS MÁQUINA, EL RETORNO DE SUBRUTINA
; "RETURN" TOMA OTROS 2 CICLOS MÁQUINA Y CADA INSTRUCCIÓN "NOP" TARDA 1 CICLO MÁQUINA.
;
RETARDO_10MICROS				; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
RETARDO_5MICROS				    ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
RETARDO_4MICROS				    ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	RETURN				        ; EL SALTO DEL RETORNO APORTA 2 CICLOS MÁQUINA.
;
; RETARDOS DE 20 HASTA 500 MICROSEGUNDOS ------------------------------------------------
;
RETARDO_500MICROS				; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
	MOVLW	D'164'		 	    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "K".
	GOTO	RETARDOMICROS		; APORTA 2 CICLOS MÁQUINA.
RETARDO_200MICROS				; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
	MOVLW	D'64'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "K".
	GOTO	RETARDOMICROS		; APORTA 2 CICLOS MÁQUINA.
RETARDO_100MICROS				; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'31'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "K".
	GOTO	RETARDOMICROS		; APORTA 2 CICLOS MÁQUINA.
RETARDO_50MICROS				; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	NOP				            ; APORTA 1 CICLO MÁQUINA.
	MOVLW	D'14'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "K".
	GOTO	RETARDOMICROS		; APORTA 2 CICLOS MÁQUINA.
RETARDO_20MICROS				; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'5'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "K".
;
; EL PRÓXIMO BLOQUE "RETARDOMICROS" TARDA:
; 1 + (K-1) + 2 + (K-1)X2 + 2 = (2 + 3K) CICLOS MÁQUINA.
;
RETARDOMICROS
	MOVWF	R_CONTA			    ; APORTA 1 CICLO MÁQUINA.
RMICROS_BUCLE
	DECFSZ	R_CONTA,F		    ; (K-1)X1 CM (CUANDO NO SALTA) + 2 CM (AL SALTAR).
	GOTO	RMICROS_BUCLE		; APORTA (K-1)X2 CICLOS MÁQUINA.
	RETURN				        ; EL SALTO DEL RETORNO APORTA 2 CICLOS MÁQUINA.
;
;EN TOTAL ESTAS SUBRUTINAS TARDAN:
; - RETARDO_500MICROS:	2 + 1 + 1 + 2 + (2 + 3K) = 500 CM = 500 µS. (PARA K=164 Y 4 MHZ).
; - RETARDO_200MICROS:	2 + 1 + 1 + 2 + (2 + 3K) = 200 CM = 200 µS. (PARA K= 64 Y 4 MHZ).
; - RETARDO_100MICROS:	2     + 1 + 2 + (2 + 3K) = 100 CM = 100 µS. (PARA K= 31 Y 4 MHZ).
; - RETARDO_50MICROS :	2 + 1 + 1 + 2 + (2 + 3K) =  50 CM =  50 µS. (PARA K= 14 Y 4 MHZ).
; - RETARDO_20MICROS :	2     + 1     + (2 + 3K) =  20 CM =  20 µS. (PARA K=  5 Y 4 MHZ).
;
; RETARDOS DE 1 MS HASTA 200 MS. --------------------------------------------------------
;
RETARDO_200MS				    ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'200'		   	    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "M".
	GOTO	RETARDOS_MS		    ; APORTA 2 CICLOS MÁQUINA.
RETARDO_100MS				    ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'100'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "M".
	GOTO	RETARDOS_MS		    ; APORTA 2 CICLOS MÁQUINA.
RETARDO_50MS				    ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'50'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "M".
	GOTO	RETARDOS_MS		    ; APORTA 2 CICLOS MÁQUINA.
RETARDO_20MS				    ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'20'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "M".
	GOTO	RETARDOS_MS		    ; APORTA 2 CICLOS MÁQUINA.
RETARDO_10MS				    ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'10'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "M".
	GOTO	RETARDOS_MS		    ; APORTA 2 CICLOS MÁQUINA.
RETARDO_5MS				        ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'5'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "M".
	GOTO	RETARDOS_MS		    ; APORTA 2 CICLOS MÁQUINA.
RETARDO_2MS				        ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'2'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "M".
	GOTO	RETARDOS_MS		    ; APORTA 2 CICLOS MÁQUINA.
RETARDO_1MS				        ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'1'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "M".
;
; EL PRÓXIMO BLOQUE "RETARDOS_MS" TARDA:
; 1 + M + M + KXM + (K-1)XM + MX2 + (K-1)MX2 + (M-1) + 2 + (M-1)X2 + 2 =
; = (2 + 4M + 4KM) CICLOS MÁQUINA. PARA K=249 Y M=1 SUPONE 1002 CICLOS MÁQUINA
; QUE A 4 MHZ SON 1002 µS = 1 MS.
;
RETARDOS_MS
	MOVWF	R_CONTB			    ; APORTA 1 CICLO MÁQUINA.
R1MS_BUCLEEXTERNO
	MOVLW	D'249'			    ; APORTA MX1 CICLOS MÁQUINA. ESTE ES EL VALOR DE "K".
	MOVWF	R_CONTA			    ; APORTA MX1 CICLOS MÁQUINA.
R1MS_BUCLEINTERNO
	NOP				            ; APORTA KXMX1 CICLOS MÁQUINA.
	DECFSZ	R_CONTA,F		    ; (K-1)XMX1 CM (CUANDO NO SALTA) + MX2 CM (AL SALTAR).
	GOTO	R1MS_BUCLEINTERNO		; APORTA (K-1)XMX2 CICLOS MÁQUINA.
	DECFSZ	R_CONTB,F		    ; (M-1)X1 CM (CUANDO NO SALTA) + 2 CM (AL SALTAR).
	GOTO	R1MS_BUCLEEXTERNO 	; APORTA (M-1)X2 CICLOS MÁQUINA.
	RETURN				        ; EL SALTO DEL RETORNO APORTA 2 CICLOS MÁQUINA.
;
;EN TOTAL ESTAS SUBRUTINAS TARDAN:
; - RETARDO_200MS:	2 + 1 + 2 + (2 + 4M + 4KM) = 200007 CM = 200 MS. (M=200 Y K=249).
; - RETARDO_100MS:	2 + 1 + 2 + (2 + 4M + 4KM) = 100007 CM = 100 MS. (M=100 Y K=249).
; - RETARDO_50MS :	2 + 1 + 2 + (2 + 4M + 4KM) =  50007 CM =  50 MS. (M= 50 Y K=249).
; - RETARDO_20MS :	2 + 1 + 2 + (2 + 4M + 4KM) =  20007 CM =  20 MS. (M= 20 Y K=249).
; - RETARDO_10MS :	2 + 1 + 2 + (2 + 4M + 4KM) =  10007 CM =  10 MS. (M= 10 Y K=249).
; - RETARDO_5MS  :	2 + 1 + 2 + (2 + 4M + 4KM) =   5007 CM =   5 MS. (M=  5 Y K=249).
; - RETARDO_2MS  :	2 + 1 + 2 + (2 + 4M + 4KM) =   2007 CM =   2 MS. (M=  2 Y K=249).
; - RETARDO_1MS  :	2 + 1     + (2 + 4M + 4KM) =   1005 CM =   1 MS. (M=  1 Y K=249).
;
; RETARDOS DE 0.5 HASTA 20 SEGUNDOS ---------------------------------------------------
;
RETARDO_20S				        ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'200'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "N".
	GOTO	RETARDO_1DECIMA		; APORTA 2 CICLOS MÁQUINA.
RETARDO_10S				        ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'100'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "N".
	GOTO	RETARDO_1DECIMA		; APORTA 2 CICLOS MÁQUINA.
RETARDO_5S				        ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'50'		 	    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "N".
	GOTO	RETARDO_1DECIMA		; APORTA 2 CICLOS MÁQUINA.
RETARDO_2S				        ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'20'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "N".
	GOTO	RETARDO_1DECIMA		; APORTA 2 CICLOS MÁQUINA.
RETARDO_1S				        ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'10'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "N".
	GOTO	RETARDO_1DECIMA		; APORTA 2 CICLOS MÁQUINA.
RETARDO_500MS				    ; LA LLAMADA "CALL" APORTA 2 CICLOS MÁQUINA.
	MOVLW	D'5'			    ; APORTA 1 CICLO MÁQUINA. ESTE ES EL VALOR DE "N".
;
; EL PRÓXIMO BLOQUE "RETARDO_1DECIMA" TARDA:
; 1 + N + N + MXN + MXN + KXMXN + (K-1)XMXN + MXNX2 + (K-1)XMXNX2 +
;   + (M-1)XN + NX2 + (M-1)XNX2 + (N-1) + 2 + (N-1)X2 + 2 =
; = (2 + 4M + 4MN + 4KM) CICLOS MÁQUINA. PARA K=249, M=100 Y N=1 SUPONE 100011
; CICLOS MÁQUINA QUE A 4 MHZ SON 100011 µS = 100 MS = 0,1 S = 1 DÉCIMA DE SEGUNDO.
;
RETARDO_1DECIMA
	MOVWF	R_CONTC			    ; APORTA 1 CICLO MÁQUINA.
R1DECIMA_BUCLEEXTERNO2
	MOVLW	D'100'			    ; APORTA NX1 CICLOS MÁQUINA. ESTE ES EL VALOR DE "M".
	MOVWF	R_CONTB			    ; APORTA NX1 CICLOS MÁQUINA.
R1DECIMA_BUCLEEXTERNO
	MOVLW	D'249'			    ; APORTA MXNX1 CICLOS MÁQUINA. ESTE ES EL VALOR DE "K".
	MOVWF	R_CONTA			    ; APORTA MXNX1 CICLOS MÁQUINA.
R1DECIMA_BUCLEINTERNO          
	NOP				            ; APORTA KXMXNX1 CICLOS MÁQUINA.
	DECFSZ	R_CONTA,F		    ; (K-1)XMXNX1 CM (SI NO SALTA) + MXNX2 CM (AL SALTAR).
	GOTO	R1DECIMA_BUCLEINTERNO	; APORTA (K-1)XMXNX2 CICLOS MÁQUINA.
	DECFSZ	R_CONTB,F		    ; (M-1)XNX1 CM (CUANDO NO SALTA) + NX2 CM (AL SALTAR).
	GOTO	R1DECIMA_BUCLEEXTERNO	; APORTA (M-1)XNX2 CICLOS MÁQUINA.
	DECFSZ	R_CONTC,F		    ; (N-1)X1 CM (CUANDO NO SALTA) + 2 CM (AL SALTAR).
	GOTO	R1DECIMA_BUCLEEXTERNO2	; APORTA (N-1)X2 CICLOS MÁQUINA.
	RETURN				        ; EL SALTO DEL RETORNO APORTA 2 CICLOS MÁQUINA.
;
;EN TOTAL ESTAS SUBRUTINAS TARDAN:
; - RETARDO_20S:	2 + 1 + 2 + (2 + 4N + 4MN + 4KMN) = 20000807 CM = 20 S.
;			(N=200, M=100 Y K=249).
; - RETARDO_10S:	2 + 1 + 2 + (2 + 4N + 4MN + 4KMN) = 10000407 CM = 10 S.
;			(N=100, M=100 Y K=249).
; - RETARDO_5S:		2 + 1 + 2 + (2 + 4N + 4MN + 4KMN) =  5000207 CM =  5 S.
;			(N= 50, M=100 Y K=249).
; - RETARDO_2S:		2 + 1 + 2 + (2 + 4N + 4MN + 4KMN) =  2000087 CM =  2 S.
;			(N= 20, M=100 Y K=249).
; - RETARDO_1S:		2 + 1 + 2 + (2 + 4N + 4MN + 4KMN) =  1000047 CM =  1 S.
;			(N= 10, M=100 Y K=249).
; - RETARDO_500MS:	2 + 1     + (2 + 4N + 4MN + 4KMN) =   500025 CM = 0,5 S.
;			(N=  5, M=100 Y K=249).

;	===================================================================
;	  DEL LIBRO "MICROCONTROLADOR PIC16F84. DESARROLLO DE PROYECTOS"
;	  E. PALACIOS, F. REMIRO Y L. LÓPEZ.
; 	  EDITORIAL RA-MA.  WWW.RA-MA.ES
;	===================================================================
